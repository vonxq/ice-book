# Ice Book - 功能规格说明

## 1. 记账功能

### 1.1 快速记账
**功能描述**: 用户可以快速记录收入或支出

**输入参数**:
- 金额 (必填): 数字输入，支持小数点后两位
- 类型 (必填): 收入/支出
- 分类 (必填): 预设分类或自定义分类
- 账户 (必填): 选择记账账户
- 日期 (可选): 默认为当前日期
- 备注 (可选): 文字描述

**业务规则**:
- 金额必须大于0
- 收入记录会增加账户余额
- 支出记录会减少账户余额
- 支持批量记账功能

**UI组件**:
```swift
struct AddRecordView: View {
    @State private var amount: String = ""
    @State private var type: RecordType = .expense
    @State private var category: String = ""
    @State private var account: String = ""
    @State private var date: Date = Date()
    @State private var note: String = ""
    
    // 表单验证
    private var isFormValid: Bool {
        !amount.isEmpty && 
        Double(amount) ?? 0 > 0 && 
        !category.isEmpty && 
        !account.isEmpty
    }
}
```

### 1.2 分类管理
**功能描述**: 管理收入和支出的分类

**预设分类**:
```
收入分类:
- 工资
- 奖金
- 投资收益
- 其他收入

支出分类:
- 餐饮
- 交通
- 购物
- 娱乐
- 医疗
- 教育
- 住房
- 其他支出
```

**自定义分类功能**:
- 用户可以添加、编辑、删除自定义分类
- 每个分类可以设置图标和颜色
- 支持分类排序

## 2. 数据统计功能

### 2.1 收支概览
**功能描述**: 显示指定时间段的收支统计

**统计维度**:
- 总收入
- 总支出
- 净收入 (收入 - 支出)
- 收支比例

**时间筛选**:
- 今日
- 本周
- 本月
- 本年
- 自定义时间段

### 2.2 分类统计
**功能描述**: 按分类统计支出情况

**统计内容**:
- 各分类支出金额
- 各分类支出占比
- 分类支出趋势

**图表展示**:
- 饼图: 显示分类占比
- 柱状图: 显示分类金额
- 折线图: 显示时间趋势

### 2.3 趋势分析
**功能描述**: 分析收支趋势

**分析维度**:
- 日趋势
- 周趋势
- 月趋势
- 年趋势

## 3. 账户管理功能

### 3.1 账户列表
**功能描述**: 管理多个账户

**账户类型**:
- 现金账户
- 银行卡
- 支付宝
- 微信钱包
- 其他

**账户信息**:
- 账户名称
- 账户余额
- 账户图标
- 账户颜色
- 是否激活

### 3.2 账户操作
**功能描述**: 账户的增删改查操作

**操作功能**:
- 添加账户
- 编辑账户信息
- 删除账户
- 账户余额调整
- 账户转账

**业务规则**:
- 删除账户前需要确认账户余额为0
- 账户转账需要记录转账记录
- 账户余额不能为负数

## 4. 预算管理功能

### 4.1 预算设置
**功能描述**: 设置月度预算

**预算类型**:
- 总预算: 设置月度总支出预算
- 分类预算: 设置特定分类的预算

**预算信息**:
- 预算金额
- 预算周期 (月度)
- 预算分类 (可选)
- 预算提醒

### 4.2 预算监控
**功能描述**: 监控预算使用情况

**监控指标**:
- 预算使用进度
- 剩余预算
- 超支情况
- 预算趋势

**提醒功能**:
- 预算使用80%提醒
- 预算超支提醒
- 预算即将到期提醒

## 5. 数据同步功能

### 5.1 iCloud同步
**功能描述**: 通过iCloud同步数据

**同步内容**:
- 记账记录
- 账户信息
- 分类信息
- 预算设置
- 用户设置

**同步策略**:
- 自动同步: 数据变更时自动同步
- 手动同步: 用户可手动触发同步
- 冲突解决: 时间戳优先策略

### 5.2 数据备份
**功能描述**: 备份和恢复数据

**备份方式**:
- iCloud自动备份
- 本地备份文件
- 导出CSV文件

**恢复功能**:
- 从iCloud恢复
- 从本地备份恢复
- 从CSV文件导入

## 6. 用户界面设计

### 6.1 主界面
**布局结构**:
```
┌─────────────────────────────────┐
│ 状态栏                          │
├─────────────────────────────────┤
│ 顶部导航栏                      │
│ [菜单] 标题 [设置]              │
├─────────────────────────────────┤
│ 内容区域                        │
│ (根据当前页面显示不同内容)        │
├─────────────────────────────────┤
│ 底部导航栏                      │
│ [首页] [统计] [账户] [设置]      │
└─────────────────────────────────┘
```

### 6.2 记账界面
**布局结构**:
```
┌─────────────────────────────────┐
│ 记账弹窗                        │
├─────────────────────────────────┤
│ 类型选择                        │
│ [支出] [收入]                   │
├─────────────────────────────────┤
│ 金额输入                        │
│ ¥__.__                          │
├─────────────────────────────────┤
│ 分类选择                        │
│ [餐饮 ▼]                        │
├─────────────────────────────────┤
│ 账户选择                        │
│ [现金 ▼]                        │
├─────────────────────────────────┤
│ 日期选择                        │
│ 2024-01-15                     │
├─────────────────────────────────┤
│ 备注输入                        │
│ ________________                │
├─────────────────────────────────┤
│ 操作按钮                        │
│ [取消] [保存]                   │
└─────────────────────────────────┘
```

## 7. 数据模型设计

### 7.1 Core Data实体关系

```swift
// 记账记录实体
@objc(Record)
public class Record: NSManagedObject {
    @NSManaged public var id: UUID
    @NSManaged public var amount: Double
    @NSManaged public var type: String
    @NSManaged public var category: String
    @NSManaged public var account: String
    @NSManaged public var date: Date
    @NSManaged public var note: String?
    @NSManaged public var createdAt: Date
    @NSManaged public var updatedAt: Date
    
    // 关联关系
    @NSManaged public var categoryEntity: Category?
    @NSManaged public var accountEntity: Account?
}

// 分类实体
@objc(Category)
public class Category: NSManagedObject {
    @NSManaged public var id: UUID
    @NSManaged public var name: String
    @NSManaged public var icon: String
    @NSManaged public var color: String
    @NSManaged public var type: String
    @NSManaged public var isDefault: Bool
    @NSManaged public var sortOrder: Int32
    
    // 关联关系
    @NSManaged public var records: Set<Record>?
}

// 账户实体
@objc(Account)
public class Account: NSManagedObject {
    @NSManaged public var id: UUID
    @NSManaged public var name: String
    @NSManaged public var balance: Double
    @NSManaged public var icon: String
    @NSManaged public var color: String
    @NSManaged public var isActive: Bool
    @NSManaged public var createdAt: Date
    
    // 关联关系
    @NSManaged public var records: Set<Record>?
}

// 预算实体
@objc(Budget)
public class Budget: NSManagedObject {
    @NSManaged public var id: UUID
    @NSManaged public var amount: Double
    @NSManaged public var spent: Double
    @NSManaged public var month: String
    @NSManaged public var category: String?
    @NSManaged public var isActive: Bool
    @NSManaged public var createdAt: Date
}
```

### 7.2 数据验证规则

```swift
// 记账记录验证
extension Record {
    func validate() throws {
        guard amount > 0 else {
            throw ValidationError.invalidAmount
        }
        
        guard !category.isEmpty else {
            throw ValidationError.emptyCategory
        }
        
        guard !account.isEmpty else {
            throw ValidationError.emptyAccount
        }
    }
}

// 账户验证
extension Account {
    func validate() throws {
        guard !name.isEmpty else {
            throw ValidationError.emptyAccountName
        }
        
        guard balance >= 0 else {
            throw ValidationError.negativeBalance
        }
    }
}
```

## 8. 性能优化策略

### 8.1 数据加载优化
- 使用分页加载大量数据
- 实现数据缓存机制
- 优化Core Data查询性能

### 8.2 UI性能优化
- 使用LazyVStack和LazyHStack
- 实现视图复用机制
- 优化动画性能

### 8.3 内存管理
- 及时释放不需要的资源
- 使用weak引用避免循环引用
- 监控内存使用情况

## 9. 错误处理机制

### 9.1 网络错误
- iCloud同步失败处理
- 网络连接异常处理
- 重试机制

### 9.2 数据错误
- 数据验证失败处理
- 数据损坏恢复机制
- 备份数据恢复

### 9.3 用户操作错误
- 输入验证错误提示
- 操作确认对话框
- 撤销操作功能

## 10. 测试策略

### 10.1 单元测试
- 数据模型测试
- 业务逻辑测试
- 工具函数测试

### 10.2 集成测试
- Core Data操作测试
- CloudKit同步测试
- UI交互测试

### 10.3 用户测试
- 功能完整性测试
- 用户体验测试
- 性能测试

## 11. 发布计划

### 11.1 内部测试
- 开发团队内部测试
- 修复已知问题
- 性能优化

### 11.2 Beta测试
- TestFlight分发
- 用户反馈收集
- 功能调整

### 11.3 正式发布
- App Store审核
- 正式版本发布
- 用户支持

---

**文档版本**: v1.0  
**最后更新**: 2024-01-15  
**维护者**: vonxq 